name: Verification Gates

on:
  workflow_dispatch:
  schedule:
    - cron: "17 5 * * *"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/verification-gates.yml"
      - "conformance/backlog_quality_gate_baseline.json"
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/fsqlite-core/**"
      - "crates/fsqlite-harness/src/backlog_quality_gate.rs"
      - "crates/fsqlite-harness/src/bin/backlog_quality_gate_runner.rs"
      - "crates/fsqlite-harness/src/bin/perf_baseline_pack_runner.rs"
      - "crates/fsqlite-harness/src/perf_loop.rs"
      - "crates/fsqlite-harness/src/performance_regression_detector.rs"
      - "crates/fsqlite-vdbe/**"
      - "scripts/verify_backlog_quality_gate.sh"
      - "scripts/verify_ci_artifact_gates.sh"
      - "scripts/verify_perf_baseline_pack.sh"
      - "scripts/coverage.sh"
      - "baselines/criterion/bd-1dp9.6.1-baseline.json"

jobs:
  backlog-quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Backlog acceptance completeness gate
        shell: bash
        run: |
          set -euo pipefail
          bash ./scripts/verify_backlog_quality_gate.sh --repo-gate

      - name: Upload backlog quality gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backlog-quality-gate-artifacts
          path: artifacts/backlog-quality-gate-e2e/
          retention-days: 21

  param-binding-regression-guard:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Anonymous placeholder + index seek regression guard
        run: |
          cargo test -p fsqlite-core test_query_with_params_table_where_two_anonymous_placeholders_bind_in_order -- --nocapture
          cargo test -p fsqlite-core test_query_with_params_table_where_then_limit_keeps_sql_placeholder_order -- --nocapture
          cargo test -p fsqlite-core test_query_with_params_table_index_eq_single_anonymous_uses_bound_value -- --nocapture
          cargo test -p fsqlite-core test_query_with_params_table_index_eq_single_anonymous_no_match_returns_empty -- --nocapture
          cargo test -p fsqlite-vdbe test_codegen_select_with_index -- --nocapture

  e2e-scenario-matrix:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        lane:
          - id: smoke
            scenario_tier: infra
            subcommand: run-smoke
            seed: 424242
          - id: correctness
            scenario_tier: correctness
            subcommand: run-correctness
            seed: 525252
          - id: recovery
            scenario_tier: recovery
            subcommand: run-recovery
            seed: 626262
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
      MATRIX_MANIFEST_VERSION: fsqlite-ci.e2e-matrix.v1
      MATRIX_SUMMARY_SCHEMA_VERSION: fsqlite-ci.e2e-matrix-summary.v1
      LANE_ID: ${{ matrix.lane.id }}
      SCENARIO_TIER: ${{ matrix.lane.scenario_tier }}
      LANE_SUBCOMMAND: ${{ matrix.lane.subcommand }}
      LANE_SEED: ${{ matrix.lane.seed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Create lane artifacts root
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "artifacts/e2e-matrix/${LANE_ID}/logs"

      - name: Run deterministic E2E lane
        shell: bash
        run: |
          set -euo pipefail

          artifact_root="artifacts/e2e-matrix/${LANE_ID}"
          run_dir="${artifact_root}/run"
          summary_json="${artifact_root}/summary.json"
          summary_md="${artifact_root}/summary.md"
          log_file="${artifact_root}/logs/e2e_runner.log"
          manifest_json="${artifact_root}/orchestrator_manifest.json"
          orchestrator_summary_json="${artifact_root}/orchestrator_summary.json"
          drift_report_json="${artifact_root}/scenario_drift_report.json"
          drift_report_md="${artifact_root}/scenario_drift_summary.md"

          mkdir -p "${run_dir}"

          started_epoch="$(date +%s)"
          set +e
          cargo run -p fsqlite-e2e --bin e2e-runner -- \
            --json \
            --seed "${LANE_SEED}" \
            --output "${run_dir}" \
            "${LANE_SUBCOMMAND}" 2>&1 | tee "${log_file}"
          lane_status=${PIPESTATUS[0]}
          set -e
          duration_seconds="$(( $(date +%s) - started_epoch ))"

          # Capture canonical full-suite manifest/summary for this deterministic seed.
          # This is evidence-only for bd-mblr.3.2.1 and should not fail the lane yet.
          set +e
          cargo run -p fsqlite-harness --bin e2e_full_suite_runner -- \
            --root-seed "${LANE_SEED}" \
            --workspace-root "${GITHUB_WORKSPACE}" \
            --run-dir "${artifact_root}/orchestrator-run" \
            --manifest-out "${manifest_json}" \
            --summary-out "${orchestrator_summary_json}" \
            > "${artifact_root}/logs/e2e_full_suite_runner.log" 2>&1
          orchestrator_status=$?
          set -e

          # Enforce scenario-to-script drift gate for required lanes.
          set +e
          cargo run -p fsqlite-harness --bin scenario_coverage_drift_gate_runner -- \
            --workspace-root "${GITHUB_WORKSPACE}" \
            --run-dir "${artifact_root}/scenario-drift-run" \
            --root-seed "${LANE_SEED}" \
            --output-json "${drift_report_json}" \
            --output-human "${drift_report_md}" \
            > "${artifact_root}/logs/scenario_coverage_drift_gate_runner.log" 2>&1
          drift_gate_status=$?
          set -e

          results_file="${run_dir}/results.json"
          if [[ -f "${results_file}" ]]; then
            total_tests="$(jq -r '.summary.total_tests // 0' "${results_file}")"
            passed_tests="$(jq -r '.summary.passed // 0' "${results_file}")"
            failed_tests="$(jq -r '.summary.failed // 0' "${results_file}")"
            skipped_tests="$(jq -r '.summary.skipped // 0' "${results_file}")"
          else
            total_tests=0
            passed_tests=0
            failed_tests=0
            skipped_tests=0
          fi

          jq -n \
            --arg schema_version "${MATRIX_SUMMARY_SCHEMA_VERSION}" \
            --arg manifest_version "${MATRIX_MANIFEST_VERSION}" \
            --arg lane_id "${LANE_ID}" \
            --arg scenario_tier "${SCENARIO_TIER}" \
            --arg subcommand "${LANE_SUBCOMMAND}" \
            --argjson seed "${LANE_SEED}" \
            --argjson lane_exit_code "${lane_status}" \
            --argjson orchestrator_exit_code "${orchestrator_status}" \
            --argjson drift_gate_exit_code "${drift_gate_status}" \
            --arg results_file "${results_file}" \
            --arg orchestrator_manifest "${manifest_json}" \
            --arg orchestrator_summary "${orchestrator_summary_json}" \
            --arg drift_report "${drift_report_json}" \
            --arg log_file "${log_file}" \
            --argjson duration_seconds "${duration_seconds}" \
            --argjson total_tests "${total_tests}" \
            --argjson passed_tests "${passed_tests}" \
            --argjson failed_tests "${failed_tests}" \
            --argjson skipped_tests "${skipped_tests}" \
            '{
              schema_version: $schema_version,
              manifest_version: $manifest_version,
              lane_id: $lane_id,
              scenario_tier: $scenario_tier,
              subcommand: $subcommand,
              seed: $seed,
              lane_exit_code: $lane_exit_code,
              orchestrator_exit_code: $orchestrator_exit_code,
              drift_gate_exit_code: $drift_gate_exit_code,
              duration_seconds: $duration_seconds,
              summary: {
                total_tests: $total_tests,
                passed: $passed_tests,
                failed: $failed_tests,
                skipped: $skipped_tests
              },
              artifacts: {
                results_file: $results_file,
                log_file: $log_file,
                orchestrator_manifest: $orchestrator_manifest,
                orchestrator_summary: $orchestrator_summary,
                scenario_drift_report: $drift_report
              }
            }' > "${summary_json}"

          {
            echo "# E2E Matrix Lane: ${LANE_ID}"
            echo
            echo "- manifest_version: \`${MATRIX_MANIFEST_VERSION}\`"
            echo "- scenario_tier: \`${SCENARIO_TIER}\`"
            echo "- subcommand: \`${LANE_SUBCOMMAND}\`"
            echo "- seed: \`${LANE_SEED}\`"
            echo "- duration_seconds: ${duration_seconds}"
            echo "- lane_exit_code: ${lane_status}"
            echo "- orchestrator_exit_code: ${orchestrator_status} (evidence-only)"
            echo "- drift_gate_exit_code: ${drift_gate_status} (enforced)"
            echo
            echo "## Test Summary"
            echo "- total: ${total_tests}"
            echo "- passed: ${passed_tests}"
            echo "- failed: ${failed_tests}"
            echo "- skipped: ${skipped_tests}"
            echo
            echo "## Artifacts"
            echo "- results: \`${results_file}\`"
            echo "- lane log: \`${log_file}\`"
            echo "- orchestrator manifest: \`${manifest_json}\`"
            echo "- orchestrator summary: \`${orchestrator_summary_json}\`"
            echo "- scenario drift report: \`${drift_report_json}\`"
          } > "${summary_md}"

          {
            echo "### E2E matrix lane ${LANE_ID}"
            echo "- scenario_tier: \`${SCENARIO_TIER}\`"
            echo "- seed: \`${LANE_SEED}\`"
            echo "- lane_exit_code: ${lane_status}"
            echo "- orchestrator_exit_code: ${orchestrator_status} (non-blocking evidence)"
            echo "- drift_gate_exit_code: ${drift_gate_status} (blocking gate)"
            echo "- summary: \`${summary_json}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

          final_status="${lane_status}"
          if [[ ${drift_gate_status} -ne 0 && ${final_status} -eq 0 ]]; then
            final_status="${drift_gate_status}"
          fi

          if [[ ${final_status} -ne 0 ]]; then
            exit "${final_status}"
          fi

      - name: Upload E2E matrix lane artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-matrix-${{ matrix.lane.id }}-artifacts
          path: artifacts/e2e-matrix/${{ matrix.lane.id }}/
          retention-days: 21

  ci-artifact-gates:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Install cargo-llvm-cov
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-llvm-cov --locked

      - name: Install miri component
        shell: bash
        run: |
          set -euo pipefail
          rustup component add miri --toolchain nightly

      - name: Run CI artifact gate orchestrator
        shell: bash
        run: |
          set -euo pipefail
          bash ./scripts/verify_ci_artifact_gates.sh

      - name: Publish CI artifact gate summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          summary_path="artifacts/ci-artifact-gates/summary.md"
          if [[ -f "${summary_path}" ]]; then
            cat "${summary_path}" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "CI artifact gate summary missing at ${summary_path}" >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Upload CI artifact gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifact-gates-artifacts
          path: |
            artifacts/ci-artifact-gates/
            artifacts/perf/bd-1dp9.6.1/
            target/coverage/
          retention-days: 21

  verification-gates:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Phase 5 regression guard parser checks
        run: |
          echo "=== Phase 5 regression guard parser checks ==="
          cargo test -p fsqlite-harness --test phase5_regression_guard -- --nocapture

      - name: Golden corpus immutability guardrail
        run: |
          echo "=== Golden corpus checksums.sha256 guardrail ==="
          # Verify checksums.sha256 exists and is well-formed (Rust test)
          cargo test -p fsqlite-e2e --test golden_integrity -- checksums_sha256 --nocapture
          # If golden .db files are present, verify their hashes match
          cargo test -p fsqlite-e2e --test golden_integrity -- golden_checksum_file_matches_actual_hashes --nocapture

      - name: E2E smoke test (deterministic workload + integrity check)
        run: |
          echo "=== E2E smoke test ==="
          cargo run -p fsqlite-e2e --bin e2e-runner -- run-smoke --json \
            2>&1 | tee artifacts/e2e_smoke.json
          echo "=== E2E correctness tests ==="
          cargo run -p fsqlite-e2e --bin e2e-runner -- \
            --output artifacts/e2e-correctness --json run-correctness \
            2>&1 | tee artifacts/e2e_correctness.json

      - name: Run Phase 1-3 verification gates
        run: |
          cargo run -p fsqlite-harness --bin phase_1_3_gate_runner -- artifacts/phase_1_3_gate_report.json \
            2>&1 | tee artifacts/phase_1_3_gate_runner.log

      - name: Run Phase 4-6 verification gates
        run: |
          cargo run -p fsqlite-harness --bin phase_4_6_gate_runner -- artifacts/phase_4_6_gate_report.json \
            2>&1 | tee artifacts/phase_4_6_gate_runner.log

      - name: Run Phase 7-9 verification gates
        run: |
          cargo run -p fsqlite-harness --bin phase_7_9_gate_runner -- artifacts/phase_7_9_gate_report.json \
            2>&1 | tee artifacts/phase_7_9_gate_runner.log

      - name: "Perf regression tracking (optional, non-blocking)"
        continue-on-error: true
        run: |
          echo "=== Perf regression: concurrency workload ==="
          # Create a tiny seed database for the perf workload.
          mkdir -p /tmp/perf-seed
          sqlite3 /tmp/perf-seed/seed.db "CREATE TABLE seed (id INTEGER PRIMARY KEY);"
          cargo run -p fsqlite-e2e --bin realdb-e2e -- run \
            --engine sqlite3 --db /tmp/perf-seed/seed.db --workload commutative_inserts \
            --concurrency 1,2,4 --repeat 3 --output-jsonl artifacts/perf_regression.jsonl \
            2>&1 | tee artifacts/perf_regression.log || true
          echo "=== Perf data captured (non-blocking) ==="

      - name: Upload verification gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-gate-reports
          path: artifacts/
