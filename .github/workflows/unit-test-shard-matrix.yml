name: Unit Test Shard Matrix

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/unit-test-shard-matrix.yml"
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/**"

jobs:
  unit-shards:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        shard:
          - id: storage-foundation
            risk_tier: high
            crates: "fsqlite-types fsqlite-error fsqlite-observability fsqlite-vfs fsqlite-pager fsqlite-wal fsqlite-mvcc fsqlite-btree"
          - id: sql-engine
            risk_tier: high
            crates: "fsqlite-ast fsqlite-parser fsqlite-planner fsqlite-vdbe fsqlite-func fsqlite-core fsqlite"
          - id: extensions
            risk_tier: medium
            crates: "fsqlite-ext-fts3 fsqlite-ext-fts5 fsqlite-ext-json fsqlite-ext-rtree fsqlite-ext-session fsqlite-ext-icu fsqlite-ext-misc"
          - id: harness-and-tools
            risk_tier: medium
            crates: "fsqlite-harness fsqlite-e2e fsqlite-cli"
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
      SHARD_ID: ${{ matrix.shard.id }}
      RISK_TIER: ${{ matrix.shard.risk_tier }}
      CRATE_LIST: ${{ matrix.shard.crates }}
      SHARD_MANIFEST_VERSION: fsqlite-ci.unit-shards.v1
      SHARD_SUMMARY_SCHEMA_VERSION: fsqlite-ci.unit-shard-summary.v1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Run deterministic unit-test shard
        shell: bash
        run: |
          set -euo pipefail

          artifact_root="artifacts/unit-shards/${SHARD_ID}"
          log_dir="${artifact_root}/logs"
          summary_md="${artifact_root}/summary.md"
          summary_json="${artifact_root}/summary.json"
          passed_file="${artifact_root}/passed.txt"
          failed_file="${artifact_root}/failed.txt"

          mkdir -p "${log_dir}"
          : > "${passed_file}"
          : > "${failed_file}"

          started_at="$(date +%s)"
          crate_count=0
          failed_count=0

          {
            echo "# Unit Shard Summary: ${SHARD_ID}"
            echo
            echo "- manifest_version: \`${SHARD_MANIFEST_VERSION}\`"
            echo "- risk_tier: \`${RISK_TIER}\`"
            echo "- crates: \`${CRATE_LIST}\`"
            echo
            echo "## Results"
          } > "${summary_md}"

          for crate in ${CRATE_LIST}; do
            crate_count=$((crate_count + 1))
            log_file="${log_dir}/${crate}.log"
            test_target="--lib"

            if [[ "${crate}" == "fsqlite-cli" ]]; then
              test_target="--bins"
            fi

            echo "Running ${crate} (${test_target})..."
            set +e
            cargo test -p "${crate}" ${test_target} --locked -- --nocapture > "${log_file}" 2>&1
            status=$?
            set -e

            if [[ ${status} -eq 0 ]]; then
              echo "${crate}" >> "${passed_file}"
              echo "- PASS \`${crate}\`" >> "${summary_md}"
              continue
            fi

            failed_count=$((failed_count + 1))
            echo "${crate}" >> "${failed_file}"
            echo "- FAIL \`${crate}\` (exit ${status}) â€” see \`logs/${crate}.log\`" >> "${summary_md}"

            {
              echo "# Failure excerpt for ${crate}"
              grep -En "test result:|failures:|error:|panicked at" "${log_file}" | head -n 40 || true
            } > "${log_dir}/${crate}.failure_excerpt.txt"
          done

          duration_seconds="$(( $(date +%s) - started_at ))"
          passed_json="$(jq -Rsc 'split("\n") | map(select(length > 0))' "${passed_file}")"
          failed_json="$(jq -Rsc 'split("\n") | map(select(length > 0))' "${failed_file}")"

          jq -n \
            --arg schema_version "${SHARD_SUMMARY_SCHEMA_VERSION}" \
            --arg manifest_version "${SHARD_MANIFEST_VERSION}" \
            --arg shard_id "${SHARD_ID}" \
            --arg risk_tier "${RISK_TIER}" \
            --arg crate_list "${CRATE_LIST}" \
            --argjson crate_count "${crate_count}" \
            --argjson passed_crates "${passed_json}" \
            --argjson failed_crates "${failed_json}" \
            --argjson failed_count "${failed_count}" \
            --argjson duration_seconds "${duration_seconds}" \
            '{
              schema_version: $schema_version,
              manifest_version: $manifest_version,
              shard_id: $shard_id,
              risk_tier: $risk_tier,
              crate_count: $crate_count,
              crates: ($crate_list | split(" ")),
              passed_crates: $passed_crates,
              failed_crates: $failed_crates,
              failed_count: $failed_count,
              duration_seconds: $duration_seconds
            }' > "${summary_json}"

          {
            echo
            echo "## Totals"
            echo "- crates_run: ${crate_count}"
            echo "- failed_crates: ${failed_count}"
            echo "- duration_seconds: ${duration_seconds}"
          } >> "${summary_md}"

          {
            echo "### Unit shard ${SHARD_ID} (${RISK_TIER})"
            echo "- crates_run: ${crate_count}"
            echo "- failed_crates: ${failed_count}"
            if [[ ${failed_count} -gt 0 ]]; then
              failures="$(tr '\n' ' ' < "${failed_file}" | sed -e 's/  */ /g' -e 's/ $//')"
              echo "- failures: \`${failures}\`"
            else
              echo "- failures: none"
            fi
            echo "- summary: \`${summary_json}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

          if [[ ${failed_count} -ne 0 ]]; then
            exit 1
          fi

      - name: Upload unit-shard artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-shard-${{ matrix.shard.id }}-artifacts
          path: artifacts/unit-shards/${{ matrix.shard.id }}/
          retention-days: 21

  unit-coverage-drift-gate:
    needs: unit-shards
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Install cargo-llvm-cov
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-llvm-cov --locked

      - name: Download unit-shard artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/downloaded-unit-shards
          pattern: unit-shard-*-artifacts
          merge-multiple: false

      - name: Run canonical coverage wrapper + per-crate delta report
        shell: bash
        run: |
          set -euo pipefail

          artifact_root="artifacts/unit-coverage-drift-gate"
          coverage_root="${artifact_root}/coverage"
          coverage_log="${coverage_root}/coverage_wrapper.log"
          coverage_status_file="${artifact_root}/coverage_wrapper.status"
          coverage_json="${coverage_root}/coverage_latest.json"
          per_crate_json="${coverage_root}/coverage_per_crate_delta.json"

          mkdir -p "${coverage_root}"

          set +e
          bash ./scripts/coverage.sh --json --fail-under-lines 70 --fail-under-functions 65 \
            > "${coverage_log}" 2>&1
          coverage_status=$?
          set -e
          printf '%s\n' "${coverage_status}" > "${coverage_status_file}"

          if [[ -f "target/coverage/coverage_latest.json" ]]; then
            cp "target/coverage/coverage_latest.json" "${coverage_json}"
          fi

          if [[ -f "${coverage_json}" ]]; then
            jq '
              def crate_name($f):
                if ($f | test("/crates/[^/]+/")) then
                  ($f | capture("/crates/(?<crate>[^/]+)/").crate)
                else
                  "workspace-root"
                end;
              [ .data[0].files[]
                | {
                    crate: crate_name(.filename),
                    lines_count: (.summary.lines.count // 0),
                    lines_covered: (.summary.lines.covered // 0),
                    functions_count: (.summary.functions.count // 0),
                    functions_covered: (.summary.functions.covered // 0)
                  }
              ]
              | group_by(.crate)
              | map({
                  crate: .[0].crate,
                  lines_count: (map(.lines_count) | add),
                  lines_covered: (map(.lines_covered) | add),
                  lines_percent:
                    (if (map(.lines_count) | add) > 0
                     then ((map(.lines_covered) | add) / (map(.lines_count) | add) * 100)
                     else 0 end),
                  lines_delta_vs_slo:
                    (if (map(.lines_count) | add) > 0
                     then ((map(.lines_covered) | add) / (map(.lines_count) | add) * 100 - 70)
                     else -70 end),
                  functions_count: (map(.functions_count) | add),
                  functions_covered: (map(.functions_covered) | add),
                  functions_percent:
                    (if (map(.functions_count) | add) > 0
                     then ((map(.functions_covered) | add) / (map(.functions_count) | add) * 100)
                     else 0 end),
                  functions_delta_vs_slo:
                    (if (map(.functions_count) | add) > 0
                     then ((map(.functions_covered) | add) / (map(.functions_count) | add) * 100 - 65)
                     else -65 end)
                })
              | sort_by(.crate)
            ' "${coverage_json}" > "${per_crate_json}"

            line_pct="$(jq -r '.data[0].totals.lines.percent // 0' "${coverage_json}")"
            function_pct="$(jq -r '.data[0].totals.functions.percent // 0' "${coverage_json}")"
            line_delta="$(jq -n --arg pct "${line_pct}" '($pct | tonumber) - 70')"
            function_delta="$(jq -n --arg pct "${function_pct}" '($pct | tonumber) - 65')"
            failing_crates="$(jq -r '
              [ .[]
                | select(.lines_delta_vs_slo < 0 or .functions_delta_vs_slo < 0)
                | .crate
              ] | join(", ")
            ' "${per_crate_json}")"
            if [[ -z "${failing_crates}" ]]; then
              failing_crates="none"
            fi

            {
              echo "### Canonical coverage wrapper"
              echo "- exit_code: ${coverage_status}"
              echo "- lines_pct: ${line_pct} (delta vs 70: ${line_delta})"
              echo "- functions_pct: ${function_pct} (delta vs 65: ${function_delta})"
              echo "- per_crate_delta: \`${per_crate_json}\`"
              echo "- crates_below_slo: \`${failing_crates}\`"
              echo "- local_parity_command: \`bash ./scripts/coverage.sh --json --fail-under-lines 70 --fail-under-functions 65\`"
              echo "- status_file: \`${coverage_status_file}\`"
            } >> "${GITHUB_STEP_SUMMARY}"
          else
            {
              echo "### Canonical coverage wrapper"
              echo "- exit_code: ${coverage_status}"
              echo "- coverage JSON not produced; see \`${coverage_log}\`"
              echo "- status_file: \`${coverage_status_file}\`"
            } >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Run unit coverage drift gate
        shell: bash
        run: |
          set -euo pipefail

          artifact_root="artifacts/unit-coverage-drift-gate"
          report_json="${artifact_root}/unit_coverage_drift_report.json"
          report_md="${artifact_root}/unit_coverage_drift_summary.md"
          gate_log="${artifact_root}/unit_coverage_drift_gate_runner.log"
          gate_status_file="${artifact_root}/unit_coverage_drift_gate.status"

          mkdir -p "${artifact_root}"

          set +e
          cargo run -p fsqlite-harness --bin unit_coverage_drift_gate_runner -- \
            --workspace-root "${GITHUB_WORKSPACE}" \
            --run-dir "${artifact_root}/run" \
            --unit-shard-root "${GITHUB_WORKSPACE}/artifacts/downloaded-unit-shards" \
            --output-json "${report_json}" \
            --output-human "${report_md}" \
            > "${gate_log}" 2>&1
          gate_status=$?
          set -e
          printf '%s\n' "${gate_status}" > "${gate_status_file}"

          {
            echo "### Unit coverage drift gate"
            echo "- exit_code: ${gate_status}"
            echo "- report: \`${report_json}\`"
            echo "- summary: \`${report_md}\`"
            echo "- status_file: \`${gate_status_file}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run no-mock critical-path gate
        shell: bash
        run: |
          set -euo pipefail

          artifact_root="artifacts/no-mock-critical-path-gate"
          report_json="${artifact_root}/no_mock_critical_path_report.json"
          report_md="${artifact_root}/no_mock_critical_path_summary.md"
          gate_log="${artifact_root}/no_mock_critical_path_gate_runner.log"
          gate_status_file="${artifact_root}/no_mock_critical_path_gate.status"

          mkdir -p "${artifact_root}"

          set +e
          cargo run -p fsqlite-harness --bin no_mock_critical_path_gate_runner -- \
            --output-json "${report_json}" \
            --output-human "${report_md}" \
            > "${gate_log}" 2>&1
          gate_status=$?
          set -e
          printf '%s\n' "${gate_status}" > "${gate_status_file}"

          verdict="unknown"
          blocking_count="unknown"
          warning_count="unknown"
          if [[ -f "${report_json}" ]]; then
            verdict="$(jq -r '.verdict // "unknown"' "${report_json}")"
            blocking_count="$(jq -r '.blocking_count // 0' "${report_json}")"
            warning_count="$(jq -r '.warning_count // 0' "${report_json}")"
          fi

          {
            echo "### No-mock critical-path gate"
            echo "- exit_code: ${gate_status}"
            echo "- verdict: ${verdict}"
            echo "- blocking_count: ${blocking_count}"
            echo "- warning_count: ${warning_count}"
            echo "- report: \`${report_json}\`"
            echo "- summary: \`${report_md}\`"
            echo "- status_file: \`${gate_status_file}\`"
            echo "- local_parity_command: \`cargo run -p fsqlite-harness --bin no_mock_critical_path_gate_runner -- --output-json ${report_json} --output-human ${report_md}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Enforce aggregated gate outcomes
        shell: bash
        run: |
          set -euo pipefail

          coverage_status_file="artifacts/unit-coverage-drift-gate/coverage_wrapper.status"
          unit_drift_status_file="artifacts/unit-coverage-drift-gate/unit_coverage_drift_gate.status"
          no_mock_status_file="artifacts/no-mock-critical-path-gate/no_mock_critical_path_gate.status"

          status_from_file() {
            local file_path="$1"
            if [[ -f "${file_path}" ]]; then
              tr -d '[:space:]' < "${file_path}"
            else
              echo "99"
            fi
          }

          coverage_status="$(status_from_file "${coverage_status_file}")"
          unit_drift_status="$(status_from_file "${unit_drift_status_file}")"
          no_mock_status="$(status_from_file "${no_mock_status_file}")"

          {
            echo "### Aggregated gate verdict"
            echo "- coverage_wrapper_exit: ${coverage_status}"
            echo "- unit_coverage_drift_exit: ${unit_drift_status}"
            echo "- no_mock_critical_path_exit: ${no_mock_status}"
          } >> "${GITHUB_STEP_SUMMARY}"

          if [[ "${coverage_status}" != "0" || "${unit_drift_status}" != "0" || "${no_mock_status}" != "0" ]]; then
            echo "ERROR: one or more CI coverage/no-mock gates failed."
            exit 1
          fi

      - name: Upload unit coverage drift artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-drift-gate-artifacts
          path: |
            artifacts/unit-coverage-drift-gate/
            artifacts/no-mock-critical-path-gate/
          retention-days: 21
