<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>FrankenSQLite | Spec Reanimation</title>
    
    <!-- OpenGraph & Favicon -->
    <meta property="og:title" content="FrankenSQLite Spec Evolution" />
    <meta property="og:description" content="137 commits · 10,791 lines · 12 sessions of architectural reanimation." />
    <meta property="og:image" content="og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <link rel="icon" type="image/webp" href="frankensqlite_illustration.webp" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <style>
        :root {
            --bg: #010401;
            --panel: #050805;
            --sidebar: #000000;
            --fg: #d0f0d0;
            --fg-dim: #2a5a2a;
            --primary: #39ff14; 
            --primary-dim: rgba(57, 255, 20, 0.08);
            --accent: #ff003c; 
            --electric: #00f2ff; 
            --border: #142214;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --glow: 0 0 20px rgba(57, 255, 20, 0.15);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: var(--font-sans);
            margin: 0;
            overflow: hidden;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            /* Apply the CRT filter to the entire body */
            filter: url(#crt-filter);
        }

        /* --- GPU Accelerated Background --- */
        .lab-grid {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.2;
            pointer-events: none;
            z-index: -1;
        }

        .main-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* --- Advanced CRT FX --- */
        #flashlight {
            position: fixed;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(57, 255, 20, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9996;
            transform: translate(-50%, -50%);
            mix-blend-mode: plus-lighter;
            will-change: transform;
        }

        .aberration { display: none; } /* Replaced by SVG filter */

        /* ... rest of existing styles ... */
        .app-header {
            height: 64px;
            background: var(--sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            z-index: 100;
            padding-top: env(safe-area-inset-top);
        }

        .brand { display: flex; align-items: center; gap: 12px; }
        .brand img { height: 36px; border-radius: 4px; }
        .brand h1 { font-size: 1rem; font-weight: 800; color: var(--primary); text-shadow: var(--glow); margin: 0; letter-spacing: 0.05em; }

        .app-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        .sidebar {
            width: 380px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #030303;
            overflow: hidden;
        }

        .content-header {
            height: 50px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
        }

        .tabs { display: flex; gap: 8px; }
        .tab {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            color: var(--fg-dim);
            border-radius: 4px;
        }
        .tab.active { color: var(--bg); background: var(--primary); }

        .viewport { flex: 1; position: relative; overflow: hidden; }
        .scroll-pane { height: 100%; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        .spec-container {
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 60px 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        .spec-container::after {
            content: "";
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px dashed #111;
            pointer-events: none;
        }

        .spec-content { font-family: var(--font-sans); font-size: 17px; line-height: 1.8; color: #ccc; }
        .spec-content h1, .spec-content h2 { color: var(--primary); font-family: var(--font-mono); margin-top: 2.5em; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .dock {
            background: var(--sidebar);
            border-top: 1px solid var(--border);
            padding: 15px 20px calc(15px + env(safe-area-inset-bottom));
            z-index: 100;
        }

        .evolution-map { height: 60px; background: #050505; border-radius: 6px; position: relative; margin-bottom: 15px; border: 1px solid #111; }
        .map-canvas { width: 100%; height: 100%; display: block; border-radius: 6px; }
        .map-slider { position: absolute; inset: 0; -webkit-appearance: none; background: transparent; margin: 0; z-index: 10; cursor: crosshair; }
        .map-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 2px; height: 60px; background: #fff; box-shadow: 0 0 10px #fff; }

        .dock-bottom { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .btn-lab {
            background: #000; border: 1px solid var(--border); color: var(--primary); font-family: var(--font-mono);
            font-weight: 800; padding: 10px 16px; border-radius: 6px; font-size: 11px; text-transform: uppercase; cursor: pointer;
        }
        .btn-lab:hover { background: var(--primary-dim); border-color: var(--primary); }
        .btn-play { background: var(--primary); color: #000; min-width: 100px; }

        /* --- HUD DNA --- */
        .dna-hud { width: 280px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; padding: 12px; }
        .dna-label { font-size: 8px; font-weight: 800; color: var(--fg-dim); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px; }
        .dna-bar { display: flex; height: 6px; background: #111; border-radius: 3px; overflow: hidden; }
        .dna-seg { height: 100%; transition: width 0.3s ease; }

        /* --- Metrics HUD --- */
        .metrics-hud { width: 340px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 6px; border: 1px solid var(--border); }
        .metric-item { display: flex; flex-direction: column; }
        .metric-label { font-size: 7px; color: var(--fg-dim); font-weight: 800; text-transform: uppercase; }
        .metric-value { font-size: 12px; font-weight: 800; color: #fff; font-family: var(--font-mono); }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .sidebar { position: absolute; inset: 0; width: 100%; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .kpis { display: none; }
            .dna-hud { display: none; }
            .metrics-hud { display: none; }
            .mobile-hide { display: none !important; }
            .spec-container { padding: 40px 20px; border: none; }
        }
        @media (min-width: 769px) {
            .mobile-only { display: none !important; }
            .sidebar { transform: none !important; }
        }

        #loadingOverlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .vital-pulse { width: 200px; height: 2px; background: #111; position: relative; overflow: hidden; }
        .vital-pulse::after { content: ""; position: absolute; width: 100px; height: 100%; background: var(--primary); left: -100px; animation: p 1.5s infinite; }
        @keyframes p { 100% { left: 300px; } }

        .main-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transform: scale(0.99) rotateX(0.2deg);
            transition: transform 0.3s ease;
        }

        /* --- Advanced CRT & Electric FX --- */
        .aberration {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9997;
            background: 
                linear-gradient(rgba(255, 0, 0, 0.02), transparent),
                linear-gradient(90deg, rgba(0, 255, 255, 0.02), transparent);
            mix-blend-mode: screen;
            opacity: 0.4;
        }

        #flashlight {
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(57, 255, 20, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9996;
            transform: translate(-50%, -50%);
            mix-blend-mode: plus-lighter;
        }

        .arc-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10001;
        }

        .electric-arc {
            stroke: var(--primary);
            stroke-width: 1.5;
            fill: none;
            filter: drop-shadow(0 0 8px var(--primary));
            opacity: 0;
        }

        @keyframes spark {
            0% { opacity: 0; stroke-dashoffset: 100; }
            10% { opacity: 1; stroke-dashoffset: 0; }
            30% { opacity: 0.4; }
            100% { opacity: 0; stroke-dashoffset: -100; }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-0.5deg); }
            20% { transform: translate(-2px, 0px) rotate(0.5deg); }
            30% { transform: translate(2px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(0.5deg); }
            50% { transform: translate(-1px, 2px) rotate(-0.5deg); }
            60% { transform: translate(-2px, 1px) rotate(0deg); }
            70% { transform: translate(2px, 1px) rotate(-0.5deg); }
            80% { transform: translate(-1px, -1px) rotate(0.5deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-0.5deg); }
        }

        /* --- Custom HUD --- */
        .system-hud {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 200px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            font-size: 9px;
            color: var(--primary);
            font-family: var(--font-mono);
            pointer-events: none;
            z-index: 60;
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), var(--glow);
        }

        .hud-brain { width: 32px; height: 32px; fill: var(--border); transition: all 0.3s ease; }
        .brain-glow { fill: var(--primary); filter: blur(2px); opacity: 0; transition: opacity 0.3s ease; }

        .hud-row { display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center; }
        .hud-bar { flex: 1; height: 4px; background: #111; margin-left: 10px; position: relative; border-radius: 2px; overflow: hidden; }
        .hud-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }

        .data-packet {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body data-flashlight="true">

<!-- SVG Filter Pipeline -->
<svg style="position: absolute; width: 0; height: 0;" aria-hidden="true" focusable="false">
  <defs>
    <filter id="crt-filter">
      <!-- Barrel Distortion -->
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="5" xChannelSelector="R" yChannelSelector="G" />
      
      <!-- Chromatic Aberration -->
      <feOffset in="SourceGraphic" dx="1.5" dy="0" result="red-chan" />
      <feOffset in="SourceGraphic" dx="-1.5" dy="0" result="blue-chan" />
      <feColorMatrix in="red-chan" type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
      <feColorMatrix in="blue-chan" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b" />
      <feColorMatrix in="SourceGraphic" type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g" />
      <feBlend in="r" in2="g" mode="screen" result="rg" />
      <feBlend in="rg" in2="b" mode="screen" />
    </filter>
    
    <filter id="glow-filter">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
</svg>

<div class="lab-grid"></div>
<div id="flashlight"></div>

<svg class="arc-container" id="arcContainer" viewBox="0 0 1000 1000" preserveAspectRatio="none">
    <path id="arcPath" class="electric-arc" d="" />
</svg>

<div class="system-hud" id="systemHud">
    <div style="display: flex; justify-content: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
        <svg class="hud-brain" viewBox="0 0 24 24" id="hudBrain">
            <path d="M12,2C7.58,2,4,5.58,4,10c0,2.42,1.08,4.59,2.78,6.06C6.29,16.5,6,17.21,6,18c0,1.66,1.34,3,3,3h6c1.66,0,3-1.34,3-3 c0-0.79-0.29-1.5-0.78-1.94C18.92,14.59,20,12.42,20,10C20,5.58,16.42,2,12,2z M9,19c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1 S9.55,19,9,19z M15,19c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S15.55,19,15,19z"/>
            <circle id="brainLogic" class="brain-glow" cx="12" cy="8" r="3" />
            <circle id="brainEng" class="brain-glow" cx="8" cy="12" r="2" />
            <circle id="brainArch" class="brain-glow" cx="16" cy="12" r="2" />
        </svg>
    </div>
    <div class="hud-row">
        <span>NEURAL_LOAD</span>
        <div class="hud-bar"><div id="hudLoad" class="hud-fill"></div></div>
    </div>
    <div class="hud-row">
        <span>SYNC_STATE</span>
        <span id="hudSync" style="color: var(--electric);">STABLE</span>
    </div>
    <div class="hud-row">
        <span>TISSUE_INTEGRITY</span>
        <div class="hud-bar"><div id="hudIntegrity" class="hud-fill"></div></div>
    </div>
    <div class="hud-row" style="margin-top: 8px; border-top: 1px dashed var(--border); padding-top: 8px;">
        <span>CORE_TEMP</span>
        <span id="hudTemp">36.5°C</span>
    </div>
    <div class="hud-row">
        <span>VOLTAGE</span>
        <span id="hudVoltage">240V</span>
    </div>
</div>

<div id="loadingOverlay">
    <div class="vital-pulse"></div>
    <div style="font-family: var(--font-mono); font-size: 10px; color: var(--primary); margin-top: 20px; letter-spacing: 0.5em;">REANIMATING_DNA</div>
</div>

<div class="main-container" id="mainContainer">
    <header class="app-header">
    <div class="brand">
        <button class="btn-lab mobile-only" id="btnOpenLogs">LOGS</button>
        <img src="frankensqlite_illustration.webp" alt="Logo">
        <h1>FrankenSQLite // Evolutionary_DNA</h1>
    </div>
    <div class="kpis" style="display: flex; gap: 30px;">
        <div style="display: flex; flex-direction: column;"><span style="font-size: 8px; color: var(--fg-dim);">ENTRIES</span><span id="kpiCommits" style="font-size: 14px; font-weight: 800;">-</span></div>
        <div style="display: flex; flex-direction: column;"><span style="font-size: 8px; color: var(--fg-dim);">MASS</span><span id="kpiLines" style="font-size: 14px; font-weight: 800;">-</span></div>
    </div>
    <button class="btn-lab" onclick="window.open('https://github.com/Dicklesworthstone/frankensqlite')">SOURCE</button>
</header>

<div class="app-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 10px; font-weight: 800; color: var(--fg-dim); letter-spacing: 0.2em;">LABORATORY_LOGS</span>
                <button class="btn-lab mobile-only" id="btnCloseLogs">CLOSE</button>
            </div>
            <input id="searchInput" type="text" placeholder="FILTER_EVOLUTION..." style="width:100%; background:#050505; border:1px solid var(--border); padding:10px; color:var(--primary); font-family:var(--font-mono); border-radius:4px; outline:none;">
        </div>
        <div id="commitList" class="commit-list"></div>
    </aside>

    <main class="main-content">
        <div class="content-header">
            <div class="tabs">
                <div id="tabSpec" class="tab active">THE_LEDGER</div>
                <div id="tabTimeline" class="tab">DIAGNOSTICS</div>
                <div id="tabDiff" class="tab">DELTA</div>
            </div>
            <div id="activeLabel" style="font-size: 9px; font-family: var(--font-mono); color: var(--fg-dim);"></div>
        </div>

        <div class="viewport">
            <div id="viewSpec" class="scroll-pane"><div id="specContainer" class="spec-container"><div id="specContent" class="spec-content"></div></div></div>
            <div id="viewTimeline" class="hidden scroll-pane">
                <div id="chartVelocity" style="height: 250px; margin-bottom: 30px;"></div>
                <div id="chartDistribution" style="height: 250px; margin-bottom: 30px;"></div>
                <div id="chartMass" style="height: 350px;"></div>
                <div style="position: absolute; top: 20px; right: 20px;" class="tabs mobile-hide">
                    <button class="btn-lab" id="btnDay">1D</button><button class="btn-lab" id="btnHour">1H</button><button class="btn-lab" id="btn15m">15M</button><button class="btn-lab" id="btn5m">5M</button>
                </div>
            </div>
            <div id="viewDiff" class="hidden scroll-pane"><div id="diffContent"></div></div>
        </div>
    </main>
</div>

<footer class="dock">
    <div class="evolution-map">
        <canvas id="mapCanvas" class="map-canvas"></canvas>
        <input id="commitSlider" class="map-slider" type="range" min="0" max="100" value="0">
    </div>
    
    <div class="dock-bottom">
        <div style="display: flex; gap: 8px;">
            <button id="btnPrev" class="btn-lab">PREV</button>
            <button id="btnPlay" class="btn-lab btn-play">REANIMATE</button>
            <button id="btnNext" class="btn-lab">NEXT</button>
        </div>

        <div class="dna-hud">
            <div class="dna-label">Categorical_Mutation_DNA</div>
            <div id="dnaBar" class="dna-bar"></div>
        </div>

        <div class="metrics-hud">
            <div class="metric-item"><span class="metric-label">Tissue_Lines</span><span id="metricLines" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Synaptic_Tokens</span><span id="metricTokens" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Delta_Volatility</span><span id="metricLev" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Logical_Density</span><span id="metricDensity" class="metric-value">0.0</span></div>
        </div>

        <div style="text-align: right; font-family: var(--font-mono); flex: 1; overflow: hidden;" class="mobile-hide">
            <div id="dockSubject" style="font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
            <div id="dockDetails" style="font-size: 9px; color: var(--fg-dim); text-transform: uppercase;">-</div>
        </div>
    </div>
</footer>
</div>

<!-- Deps --><script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.0/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>

<script type="module">
    const DB_URL = "spec_evolution_v1.sqlite3";
    const BUCKETS = [
        { id: 1, name: "Logic", color: "#39ff14" }, { id: 2, name: "SQLite", color: "#adff2f" },
        { id: 3, name: "Async", color: "#00ff00" }, { id: 4, name: "Arch", color: "#ff003c" },
        { id: 5, name: "Meta", color: "#666" }, { id: 6, name: "Context", color: "#d946ef" },
        { id: 7, name: "Eng", color: "#00f2ff" }, { id: 8, name: "Math", color: "#bf00ff" },
        { id: 9, name: "Clarify", color: "#00ffcc" }, { id: 10, name: "Other", color: "#475569" }
    ];

    let DB = null;
    let COMMITS = [];
    let FILTERED = []; 
    let GROUPS = new Map();
    let DOC_CACHE = new Map();
    let PATCH_CACHE = new Map();
    let METRICS = [];
    let BASE_DOC = "";
    
    const STATE = { idx: 0, q: "", tab: "spec", isPlaying: false, playInterval: null, timeBucket: "day" };

    async function init() {
        try {
            const SQL = await window.initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${file}` });
            const res = await fetch(DB_URL);
            if (!res.ok) throw new Error("Neural Core Data Fetch Failed");
            const buf = await res.arrayBuffer();
            DB = new SQL.Database(new Uint8Array(buf));
            
            const baseRes = DB.exec("SELECT text FROM base_doc LIMIT 1");
            if (baseRes.length) BASE_DOC = baseRes[0].values[0][0];
            
            loadCommits();
            loadGroups();
            setupEventListeners();
            syncNeuralFilters();
            await computeSynapticMetrics();
            renderCommitList();
            drawSynapticMap();
            
            if (COMMITS.length > 0) {
                await selectCommit(COMMITS.length - 1);
            }
            hideLoader();
        } catch (e) {
            console.error(e);
            document.getElementById("loadingOverlay").innerHTML = `<div style="color:var(--accent); font-family:var(--font-mono); font-size:12px; text-align:center; padding:20px;">REANIMATION_FAILURE:<br>${e.message}</div>`;
        }
    }

    function loadCommits() {
        const res = DB.exec("SELECT idx, hash, short, date_iso, author, subject, add_lines, del_lines, impact, primary_bucket, labels_json FROM commits ORDER BY idx ASC");
        if (!res.length) return;
        COMMITS = res[0].values.map(r => ({ 
            idx: r[0], hash: r[1], short: r[2], date: r[3], author: r[4], 
            subject: r[5], add: r[6], del: r[7], impact: r[8], 
            primary: r[9], labels: JSON.parse(r[10]) 
        }));
        document.getElementById("commitSlider").max = COMMITS.length - 1;
        document.getElementById("kpiCommits").textContent = COMMITS.length;
    }

    function loadGroups() {
        const res = DB.exec("SELECT commit_hash, labels_json FROM change_groups");
        if (!res.length) return;
        res[0].values.forEach(r => {
            const hash = r[0];
            const labels = JSON.parse(r[1]);
            if (!GROUPS.has(hash)) GROUPS.set(hash, []);
            GROUPS.get(hash).push(...labels);
        });
    }

    async function computeSynapticMetrics() {
        let lines = BASE_DOC.split("\n");
        let prevText = BASE_DOC;
        METRICS = [];
        for (let i = 0; i < COMMITS.length; i++) {
            const p = await getPatch(i);
            if (p) lines = applySynapticPatch(lines, p);
            const text = lines.join("\n");
            const tokens = text.split(/\s+/).length;
            const lev = i === 0 ? text.length : synapticDistance(prevText, text);
            METRICS.push({ lines: lines.length, tokens, lev });
            prevText = text;
            if (i % 10 === 0) DOC_CACHE.set(i, text);
        }
    }

    function synapticDistance(a, b) {
        const wa = a.split(/\s+/), wb = b.split(/\s+/);
        const m = wa.length, n = wb.length;
        if (m === 0) return n; if (n === 0) return m;
        let prev = Array.from({length: n + 1}, (_, i) => i);
        for (let i = 1; i <= m; i++) {
            let curr = [i];
            for (let j = 1; j <= n; j++) {
                curr[j] = wa[i-1] === wb[j-1] ? prev[j-1] : Math.min(prev[j-1], prev[j], curr[j-1]) + 1;
            }
            prev = curr;
        }
        return prev[n];
    }

    window.selectCommit = async function(idx) {
        STATE.idx = Math.max(0, Math.min(COMMITS.length - 1, idx));
        document.getElementById("commitSlider").value = STATE.idx;
        const c = COMMITS[STATE.idx];
        const m = METRICS[STATE.idx];
        
        const dockSubject = document.getElementById("dockSubject");
        dockSubject.textContent = c.subject;
        if(!STATE.isPlaying) decodeText(dockSubject, c.subject, 0.8);
        
        document.getElementById("dockDetails").textContent = `HASH: ${c.short} // BY: ${c.author} // TIME: ${dayjs(c.date).format("MMM DD HH:mm")}`;
        document.getElementById("activeLabel").textContent = `LOG_ENTRY_${STATE.idx} // ${c.short}`;
        
        const ml = document.getElementById("metricLines");
        const mt = document.getElementById("metricTokens");
        const mev = document.getElementById("metricLev");
        const md = document.getElementById("metricDensity");
        if(ml) ml.textContent = m.lines.toLocaleString();
        if(mt) mt.textContent = m.tokens.toLocaleString();
        if(mev) mev.textContent = m.lev.toLocaleString();
        if(md) md.textContent = (m.tokens / m.lines).toFixed(2);

        renderDNA(c);
        renderCommitList();
        await updateView();
        
        const sel = document.querySelector(".commit-card.selected");
        if (sel) sel.scrollIntoView({ block: "nearest", behavior: "smooth" });
    };

    function renderDNA(c) {
        const dna = document.getElementById("dnaBar");
        dna.innerHTML = "";
        
        // Brain Glow logic
        document.querySelectorAll('.brain-glow').forEach(el => el.style.opacity = '0');
        const primary = c.primary;
        if([1, 8, 9].includes(primary)) document.getElementById('brainLogic').style.opacity = '1';
        if([7, 3, 2].includes(primary)) document.getElementById('brainEng').style.opacity = '1';
        if([4, 6, 5].includes(primary)) document.getElementById('brainArch').style.opacity = '1';

        const labels = GROUPS.get(c.hash) || c.labels;
        if (!labels.length) {
            const s = document.createElement("div"); s.className="dna-seg"; s.style.width="100%"; s.style.background=BUCKETS[9].color;
            dna.appendChild(s); return;
        }
        const counts = {}; labels.forEach(l => counts[l] = (counts[l] || 0) + 1);
        const total = labels.length;
        Object.keys(counts).forEach(l => {
            const bucket = BUCKETS.find(b => b.id == l) || BUCKETS[9];
            const s = document.createElement("div"); s.className="dna-seg";
            s.style.width = (counts[l] / total * 100) + "%";
            s.style.background = bucket.color;
            dna.appendChild(s);
        });
    }

    async function updateView() {
        if (STATE.tab === "spec") await renderSpec();
        else if (STATE.tab === "timeline") renderCharts();
        else if (STATE.tab === "diff") await renderDiff();
    }

    async function renderSpec() {
        const el = document.getElementById("specContent");
        el.innerHTML = '<div style="color: var(--primary); font-family: var(--font-mono); font-size: 11px;">RECONSTRUCTING_TISSUE...</div>';
        const text = await reconstructSnapshot(STATE.idx);
        const md = window.markdownit({ html: true, highlight: (str, lang) => (lang && hljs.getLanguage(lang)) ? hljs.highlight(str, { language: lang }).value : '' });
        el.innerHTML = DOMPurify.sanitize(md.render(text));
        document.getElementById("kpiLines").textContent = text.split("\n").length.toLocaleString();
    }

    async function reconstructSnapshot(idx) {
        if (DOC_CACHE.has(idx)) return DOC_CACHE.get(idx);
        let startIdx = 0;
        let lines = BASE_DOC.split("\n");
        for (let i = Math.floor(idx / 10) * 10; i >= 0; i -= 10) {
            if (DOC_CACHE.has(i)) {
                startIdx = i + 1;
                lines = DOC_CACHE.get(i).split("\n");
                break;
            }
        }
        for (let i = startIdx; i <= idx; i++) {
            const p = await getPatch(i);
            if (p) lines = applySynapticPatch(lines, p);
            if (i % 10 === 0 && !DOC_CACHE.has(i)) DOC_CACHE.set(i, lines.join("\n"));
        }
        const res = lines.join("\n");
        DOC_CACHE.set(idx, res);
        return res;
    }

    function applySynapticPatch(lines, patch) {
        const out = [...lines];
        const patchLines = patch.split("\n");
        let offset = 0;
        for (let i = 0; i < patchLines.length; i++) {
            const line = patchLines[i];
            if (line.startsWith("@@")) {
                const m = line.match(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/);
                if (m) {
                    const os = parseInt(m[1]), oc = parseInt(m[2] || "1");
                    const startPos = os - 1 + offset;
                    const newSeg = [];
                    i++;
                    while (i < patchLines.length && !patchLines[i].startsWith("@@")) {
                        const row = patchLines[i];
                        if (row.startsWith("+")) newSeg.push(row.slice(1));
                        else if (!row.startsWith("-")) newSeg.push(row.slice(1));
                        i++;
                    }
                    i--;
                    out.splice(startPos, oc, ...newSeg);
                    offset += (parseInt(m[4] || "1") - oc);
                }
            }
        }
        return out;
    }

    async function getPatch(idx) {
        if (PATCH_CACHE.has(idx)) return PATCH_CACHE.get(idx);
        const res = DB.exec("SELECT patch FROM patches WHERE idx = ?", [idx]);
        const p = res.length ? res[0].values[0][0] : "";
        PATCH_CACHE.set(idx, p); return p;
    }

    async function renderDiff() {
        const el = document.getElementById("diffContent");
        const p = await getPatch(STATE.idx);
        if (!p) { el.innerHTML = "SYSTEM_STABLE: NO_DELTA"; return; }
        const diffHtml = Diff2Html.html(p, { drawFileList: false, matching: 'lines', outputFormat: 'line-by-line', colorScheme: 'dark' });
        el.innerHTML = DOMPurify.sanitize(diffHtml);
    }

    function drawSynapticMap() {
        const cvs = document.getElementById("mapCanvas");
        const ctx = cvs.getContext("2d");
        const w = cvs.width = cvs.clientWidth;
        const h = cvs.height = cvs.clientHeight;
        if (!w || !h || COMMITS.length === 0) return;
        ctx.clearRect(0, 0, w, h);
        const barW = w / COMMITS.length;
        COMMITS.forEach((c, i) => {
            const labels = GROUPS.get(c.hash) || c.labels;
            const buckets = labels.length ? labels : [10];
            const counts = {}; buckets.forEach(l => counts[l] = (counts[l] || 0) + 1);
            const total = buckets.length;
            let cy = 0;
            Object.keys(counts).forEach(l => {
                const b = BUCKETS.find(x => x.id == l) || BUCKETS[9];
                const sh = (counts[l] / total) * h;
                ctx.fillStyle = b.color; ctx.globalAlpha = 0.6;
                ctx.fillRect(i * barW, cy, barW - 1, sh);
                cy += sh;
            });
            if (c.impact > 250) { ctx.fillStyle = "#fff"; ctx.globalAlpha = 0.2; ctx.fillRect(i * barW, 0, barW - 1, h); }
        });
    }

    let charts = {};
    function renderCharts() {
        const t = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono', color: '#4a7a4a' }, grid: { top: 30, bottom: 30, left: 40, right: 20 }, xAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { show: false } }, yAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { lineStyle: { color: '#111', type: 'dashed' } } } };
        if (!charts.velocity) charts.velocity = echarts.init(document.getElementById("chartVelocity"));
        charts.velocity.setOption({ ...t, series: [{ data: COMMITS.map(c => [c.date, c.impact]), type: 'line', smooth: true, lineStyle: { color: '#39ff14' }, areaStyle: { color: 'rgba(57, 255, 20, 0.1)' } }] });
        if (!charts.dist) charts.dist = echarts.init(document.getElementById("chartDistribution"));
        const counts = {}; COMMITS.forEach(c => counts[c.primary] = (counts[c.primary] || 0) + 1);
        charts.dist.setOption({ ...t, series: [{ type: 'pie', radius: ['40%', '70%'], data: BUCKETS.map(b => ({ value: counts[b.id] || 0, name: b.name, itemStyle: { color: b.color } })) }] });
        renderMassGrowth();
    }

    function renderMassGrowth() {
        if (!charts.mass) charts.mass = echarts.init(document.getElementById("chartMass"));
        const buckets = groupCommits(STATE.timeBucket);
        const labels = Object.keys(buckets).sort();
        const series = BUCKETS.map(b => ({ name: b.name, type: 'bar', stack: 'total', itemStyle: { color: b.color }, data: labels.map(l => buckets[l][b.id] || 0) }));
        const t = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono', color: '#4a7a4a' }, grid: { top: 30, bottom: 30, left: 40, right: 20 }, xAxis: { axisLine: { lineStyle: { color: '#1a221a' } } }, yAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { lineStyle: { color: '#111' } } } };
        charts.mass.setOption({ ...t, tooltip: { trigger: 'axis' }, xAxis: { type: 'category', data: labels }, series }, true);
    }

    function groupCommits(unit) {
        const res = {};
        COMMITS.forEach(c => {
            let k; const d = dayjs(c.date);
            if (unit === "day") k = d.format("YYYY-MM-DD");
            else if (unit === "hour") k = d.format("MM-DD HH:00");
            else if (unit === "15m") k = d.format("MM-DD HH:") + (Math.floor(d.minute()/15)*15).toString().padStart(2,'0');
            else k = d.format("MM-DD HH:") + (Math.floor(d.minute()/5)*5).toString().padStart(2,'0');
            if (!res[k]) res[k] = {};
            res[k][c.primary] = (res[k][c.primary] || 0) + c.impact;
        });
        return res;
    }

    function setupEventListeners() {
        document.getElementById("searchInput").addEventListener("input", e => { STATE.q = e.target.value; syncNeuralFilters(); renderCommitList(); });
        document.getElementById("commitSlider").addEventListener("input", e => selectCommit(parseInt(e.target.value)));
        
        ["Spec", "Timeline", "Diff"].forEach(t => {
            const btn = document.getElementById("tab" + t);
            btn.addEventListener("click", e => {
                ["Spec", "Timeline", "Diff"].forEach(tt => { document.getElementById("tab" + tt).classList.remove("active"); document.getElementById("view" + tt).classList.add("hidden"); });
                e.target.classList.add("active"); document.getElementById("view" + t).classList.remove("hidden");
                
                // Kinetic title reveal
                const titleMap = { "Spec": "THE_LEDGER", "Timeline": "DIAGNOSTICS", "Diff": "DELTA" };
                decodeText(btn, titleMap[t], 0.5);
                
                STATE.tab = t.toLowerCase(); updateView();
            });
        });

        ["btnDay", "btnHour", "btn15m", "btn5m"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener("click", () => {
                STATE.timeBucket = id.replace("btn", "").toLowerCase();
                renderMassGrowth();
            });
        });

        document.getElementById("btnOpenLogs").addEventListener("click", () => document.getElementById("sidebar").classList.add("active"));
        document.getElementById("btnCloseLogs").addEventListener("click", () => document.getElementById("sidebar").classList.remove("active"));
        
        document.getElementById("btnPlay").addEventListener("click", () => {
            STATE.isPlaying = !STATE.isPlaying;
            document.getElementById("btnPlay").textContent = STATE.isPlaying ? "STABILIZE" : "REANIMATE";
            
            if (STATE.isPlaying) {
                document.body.style.animation = 'shake 0.5s infinite';
                STATE.playInterval = setInterval(() => { 
                    if (STATE.idx < COMMITS.length - 1) {
                        selectCommit(STATE.idx + 1);
                        if(Math.random() > 0.5) createElectricArc();
                    } else { 
                        clearInterval(STATE.playInterval); 
                        STATE.isPlaying = false; 
                        document.getElementById("btnPlay").textContent = "REANIMATE"; 
                        document.body.style.animation = 'none';
                    } 
                }, 200);
            } else { 
                clearInterval(STATE.playInterval); 
                document.body.style.animation = 'none';
            }
        });

        document.getElementById("btnPrev").addEventListener("click", () => selectCommit(STATE.idx - 1));
        document.getElementById("btnNext").addEventListener("click", () => selectCommit(STATE.idx + 1));
        window.addEventListener("resize", () => { drawSynapticMap(); Object.values(charts).forEach(c => c.resize()); });
    }

    function syncNeuralFilters() { const q = STATE.q.toLowerCase(); FILTERED = COMMITS.filter(c => !q || c.subject.toLowerCase().includes(q) || c.hash.includes(q)); }
    
    function renderCommitList() {
        const container = document.getElementById("commitList");
        container.innerHTML = FILTERED.slice().reverse().map(c => {
            const b = BUCKETS.find(x => x.id === c.primary) || BUCKETS[9];
            const sel = c.idx === STATE.idx ? "selected" : "";
            return `<div class="commit-card ${sel}" onclick="window.selectCommit(${c.idx}); document.getElementById('sidebar').classList.remove('active');"><div class="commit-card-header"><span>ENT_${c.idx}</span><span style="color: var(--fg-dim)">${dayjs(c.date).format("MMM DD")}</span></div><div class="commit-card-subject">${escapeHtml(c.subject)}</div><div class="commit-card-meta"><span style="color:${b.color}">${b.name}</span><span style="color:var(--primary)">+${c.add}</span></div></div>`;
        }).join("");
    }

    function hideLoader() {
        document.getElementById("loadingOverlay").style.opacity = '0';
        setTimeout(() => {
            document.getElementById("loadingOverlay").classList.add("hidden");
            // Start kinetic reveals
            decodeText(document.querySelector('.brand h1'), "FrankenSQLite // Evolutionary_DNA", 1.5);
            decodeText(document.querySelector('.sidebar-header span'), "LABORATORY_LOGS", 1.2, 0.5);
            startLabEffects();
        }, 500);
    }

    // --- Kinetic & Lab Effects ---

    const CHARS = "01$!@#%^&*()_+{}:<>?[]|";

    function decodeText(element, targetText, duration = 1, delay = 0) {
        if (!element || !targetText) return;
        const dur = Math.max(0.01, duration);
        setTimeout(() => {
            let iteration = 0;
            const maxIterations = targetText.length;
            const startTime = Date.now();
            element.innerText = "";
            const interval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                iteration = (elapsed / dur) * maxIterations;
                element.innerText = targetText.split("").map((char, index) => {
                    if (index < iteration) return targetText[index];
                    if (char === " ") return " ";
                    return CHARS[Math.floor(Math.random() * CHARS.length)];
                }).join("");
                if (iteration >= maxIterations) { clearInterval(interval); element.innerText = targetText; }
            }, 30);
        }, delay * 1000);
    }

    function startLabEffects() {
        function packetLoop() {
            if (document.visibilityState === 'visible' && Math.random() > 0.98) { createDataPacket(); }
            requestAnimationFrame(packetLoop);
        }
        packetLoop();
        setInterval(updateSystemHud, 1000);
        setInterval(maybeSpark, 3000);
        const flashlight = document.getElementById('flashlight');
        document.addEventListener('mousemove', (e) => {
            let x = e.clientX, y = e.clientY;
            const targets = document.querySelectorAll('button, .commit-card, .tab');
            let nearestDist = 150;
            targets.forEach(t => {
                const r = t.getBoundingClientRect();
                const tx = r.left + r.width/2, ty = r.top + r.height/2;
                const d = Math.hypot(x - tx, y - ty);
                if (d < nearestDist) { x = x * 0.85 + tx * 0.15; y = y * 0.85 + ty * 0.15; }
            });
            if(flashlight) flashlight.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
        });
    }

    function updateSystemHud() {
        const isReanimating = STATE.isPlaying;
        const load = isReanimating ? (80 + Math.random() * 20) : (5 + Math.random() * 15);
        const integrity = isReanimating ? (90 + Math.random() * 5) : (99 + Math.random() * 1);
        const temp = (isReanimating ? (42 + Math.random() * 5) : (36 + Math.random() * 0.5)).toFixed(1);
        const voltage = isReanimating ? (400 + Math.floor(Math.random() * 100)) : (230 + Math.floor(Math.random() * 10));

        const shift = (load / 100) * 2.5;
        const offR = document.querySelector('#crt-filter feOffset[result="red-chan"]');
        const offB = document.querySelector('#crt-filter feOffset[result="blue-chan"]');
        if(offR) offR.setAttribute('dx', shift);
        if(offB) offB.setAttribute('dx', -shift);

        const hl = document.getElementById('hudLoad'), hi = document.getElementById('hudIntegrity');
        if(hl) hl.style.width = load + '%'; if(hi) hi.style.width = integrity + '%';
        const ht = document.getElementById('hudTemp'), hv = document.getElementById('hudVoltage');
        if(ht) ht.innerText = temp + '°C'; if(hv) hv.innerText = voltage + 'V';
        const syncs = isReanimating ? ["STRESS", "CRITICAL", "REANIMATING", "OVERLOAD"] : ["STABLE", "SYNCING", "IDLE", "CALIBRATED"];
        const hs = document.getElementById('hudSync');
        if(hs) {
            hs.innerText = syncs[Math.floor(Math.random() * syncs.length)];
            hs.style.color = isReanimating ? 'var(--accent)' : 'var(--electric)';
        }
    }

    function maybeSpark() { const threshold = STATE.isPlaying ? 0.3 : 0.8; if (Math.random() > threshold) createElectricArc(); }

    function createElectricArc() {
        const path = document.getElementById('arcPath');
        const w = window.innerWidth, h = window.innerHeight;
        const points = [{x: 10, y: 10}, {x: w-10, y: 10}, {x: 10, y: h-10}, {x: w-10, y: h-10}];
        const p1 = points[Math.floor(Math.random() * points.length)];
        let p2 = points[Math.floor(Math.random() * points.length)];
        while(p1 === p2) p2 = points[Math.floor(Math.random() * points.length)];
        let d = `M ${p1.x} ${p1.y}`;
        const segments = 12;
        for(let i=1; i<segments; i++) {
            const tx = p1.x + (p2.x - p1.x) * (i / segments), ty = p1.y + (p2.y - p1.y) * (i / segments);
            d += ` L ${tx + (Math.random() - 0.5) * 120} ${ty + (Math.random() - 0.5) * 120}`;
        }
        d += ` L ${p2.x} ${p2.y}`;
        path.setAttribute('d', d); path.style.animation = 'none'; path.getBoundingClientRect(); 
        path.style.animation = 'spark 0.3s ease-out forwards';
    }

    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }

    init();
</script>
</body>
</html>